import torch
import re
from transformers import BartForConditionalGeneration
from kobart import get_kobart_tokenizer # 기존 tokenizer 호출 방식 유지

class MUTRSummaryTester:
    def __init__(self):
        self.device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
        
        # main.py와 동일한 모델 및 토크나이저 설정
        self.kb_tokenizer = get_kobart_tokenizer()
        self.kb_model = BartForConditionalGeneration.from_pretrained("EbanLee/kobart-title").to(self.device)
        self.kb_model.eval()
        print(f"✅ MUTR kobart-title 모델 로드 완료 ({self.device})")

    def _clean_topic(self, text):
        """main.py의 정제 로직 그대로 유지"""
        # 1. 대괄호 및 소괄호 내용 제거
        text = re.sub(r"\[.*?\]|\(.*?\)", "", text).strip()
        # 콤마 기준 분리 후 중복 제거
        parts = [p.strip() for p in text.split(',')]
        return ", ".join(dict.fromkeys(parts))

    def test_summary(self, content):
        """main.py의 analyze 내 요약 로직 그대로 수행"""
        # full_context가 없는 단독 테스트이므로 content만 입력으로 사용
        kb_inputs = self.kb_tokenizer(content, return_tensors="pt", truncation=True, max_length=1024).to(self.device)
        
        with torch.no_grad():
            summary_ids = self.kb_model.generate(
                input_ids=kb_inputs['input_ids'],
                max_length=40,
                num_beams=4,
                repetition_penalty=4.5,
                no_repeat_ngram_size=2,
                early_stopping=True
            )
        raw_topic = self.kb_tokenizer.decode(summary_ids[0], skip_special_tokens=True)
        return self._clean_topic(raw_topic)

def run_100_tests():
    tester = MUTRSummaryTester()
    
    # 요청하신 100가지 테스트 케이스
    test_cases = [
        # [1-20] 노이즈 및 초단문
        "ㅋㅋㅋ", "ㅠㅠ", "안녕", "하이", "머쓱", "...", "호잇", "뭐지?", "잉", "랄랄라",
        "어이구", "헐 대박", "바이바이", "랄라", "음...", "허허", "오잉?", "글쎄", "메롱", "쉿",
        
        # [21-40] 일상 활동
        "퇴근하고 집에 오는 길에 붕어빵을 사 먹었어. 겨울이 온 게 실감 나네.",
        "헬스장에서 하체 운동을 했는데 다리가 후들거려서 걷기가 힘들어.",
        "장바구니 물가가 너무 올라서 계란 한 판 사는 것도 고민되더라.",
        "비가 하루 종일 내려서 집에서 부침개 해 먹었는데 너무 맛있었어.",
        "지하철에서 졸다가 내려야 할 역을 지나쳐버렸어. 덕분에 지각이야.",
        "강아지랑 산책 나갔다가 동네 고양이를 만났는데 둘이 한참을 쳐다보더라.",
        "오늘 점심은 새로 생긴 파스타 가게에 갔는데 생각보다 별로였어.",
        "세차를 하자마자 비가 오다니 정말 운이 없는 하루야.",
        "편의점에서 새로 나온 컵라면을 먹어봤는데 국물이 끝내주네.",
        "도서관에서 공부하다가 깜빡 잠들었는데 꿈속에서도 공부를 했어.",
        "주말에 등산을 다녀왔더니 온몸에 근육통이 생겨서 움직이기 힘들어.",
        "빨래를 돌려놓고 깜빡해서 다시 돌려야 해. 정신이 없네.",
        "아침 일찍 일어나서 요가를 했더니 몸이 가벼워진 기분이야.",
        "우체국에 가서 부모님께 드릴 택배를 보냈어. 좋아하셨으면 좋겠다.",
        "마트에서 1+1 행사를 하길래 우유를 득템했어. 소소한 행복이야.",
        "택배 상자를 뜯을 때가 하루 중 가장 설레는 순간인 것 같아.",
        "버스를 기다리는데 계속 반대 방향 버스만 와서 너무 답답했어.",
        "매일 영양제를 챙겨 먹는 게 생각보다 귀찮지만 건강을 위해 참아야지.",
        "다이어리를 새로 샀는데 첫 페이지를 채우는 게 가장 어려워.",
        "비 오는 창밖을 보며 따뜻한 코코아 한 잔 마시는 여유를 즐겼어.",

        # [41-60] 깊은 감정 및 내면 성찰
        "가끔은 내가 잘하고 있는 건지 불안할 때가 있어.",
        "오래된 사진첩을 보니 어릴 적 꿈꿨던 내 모습이 떠올라 코끝이 찡해.",
        "누군가에게 마음을 털어놓는 게 점점 어려워져. 혼자가 편해.",
        "실패는 아프지만 나를 더 성장하게 만들 거라고 믿어.",
        "나 자신을 사랑하는 법을 배우는 중이야. 내 마음이 가장 중요하니까.",
        "그때 그 말을 하지 말았어야 했는데. 후회는 항상 늦네.",
        "작은 것에 감사하며 살기로 했어. 아침의 차 한 잔 같은 것들.",
        "세상은 빠른데 나만 멈춰 선 기분이 들 때가 있어.",
        "새벽에 깨어 있으면 세상에 나만 남겨진 것 같은 고요함이 좋아.",
        "그리운 사람의 목소리가 환청처럼 들릴 때가 있어. 보고 싶다.",
        "새로운 시작은 늘 두렵지만 그만큼의 설렘도 함께 오는 법이지.",
        "아무것도 하기 싫은 무기력한 날이야. 그냥 누워서 천장만 보고 싶어.",
        "가슴 벅찬 감동을 느꼈던 영화를 봤어. 인생 영화가 될 것 같아.",
        "용기 내어 말하고 나니 마음이 한결 가벼워졌어. 진작 그럴걸.",
        "삶의 무게가 무겁게 느껴질 때면 잠시 쉬어가도 괜찮아.",
        "내 안의 화를 다스리는 게 가장 어려운 숙제인 것 같아.",
        "평화로운 오후의 햇살이 내 방 안을 가득 채우니 마음이 편안해져.",
        "꿈꾸는 소년처럼 살고 싶은데 현실은 자꾸 나를 어른으로 만드네.",
        "외로움은 익숙해지지 않는 감정인 것 같아. 늘 낯설고 아파.",
        "오늘 하루도 수고한 나에게 맛있는 저녁 선물을 해줘야지.",

        # [61-80] 시사 및 뉴스 키워드
        "삼성전자 주가가 오늘 좀 올라서 기쁘다. 내 주식도 빨간불이야.",
        "기후 위기가 심각하다는데 텀블러라도 꼭 챙겨 다녀야지.",
        "금리가 또 오른다니 대출 이자 걱정에 밤잠을 설칠 것 같아.",
        "손흥민 선수가 오늘 골을 넣었어! 월요일 아침이 활기차네.",
        "정치 뉴스 보면 한숨만 나오지만 투표는 꼭 해야겠어.",
        "인공지능 기술이 발전하는 속도를 보면 가끔 무섭기도 해.",
        "나스닥 지수가 폭락했다는 소식에 가슴이 철렁했어.",
        "가상화폐 투자를 시작했는데 변동성이 너무 커서 불안해.",
        "전세 사기 뉴스를 보니 남 일 같지 않아서 마음이 무거워.",
        "고령화 사회에 대비해 노후 준비를 미리 시작해야겠어.",
        "우리나라에서 우주 발사체를 쏘아 올렸다니 정말 자랑스러워.",
        "저출산 문제가 심각하다는데 미래의 아이들은 어떤 세상에 살까.",
        "반도체 수급 문제로 새 차를 받으려면 1년은 기다려야 한대.",
        "오염수 방류 뉴스를 접하고 나니 수산물 먹기가 꺼려져.",
        "최저 임금이 인상된다는데 자영업자분들의 고민이 깊어지겠어.",
        "부동산 대책이 새로 발표될 때마다 어디로 이사 가야 할지 고민이야.",
        "독감이 유행이라는데 미리 백신을 맞길 잘한 것 같아.",
        "한미 정상회담 소식을 보며 국제 정세의 복잡함을 다시 느껴.",
        "고물가 시대에 만 원으로 밥 한 끼 먹기도 힘든 현실이 씁쓸해.",
        "올림픽 개막식을 보며 국가대표 선수들의 열정을 응원했어.",

        # [81-100] 은하계/맥락 기반
        "내 마음속에 작은 블랙홀이 생긴 것 같아. 모든 걸 빨아들여.",
        "우리는 각자의 궤도를 도는 별들일 거야. 언젠가 만날 거야.",
        "어둠이 깊을수록 별은 더 밝게 빛난다는 걸 잊지 말자.",
        "내 기억을 모아 우주 한구석에 예쁜 성운을 만들고 싶어.",
        "안드로메다 은하까지 날아가고 싶은 상상에 빠져보곤 해.",
        "초신성이 폭발하듯 내 열정도 한 번쯤은 뜨겁게 타올랐으면 해.",
        "평행 우주가 있다면 그곳의 나는 지금보다 더 행복할까?",
        "이전 요약: 첫 데이트. 현재 글: 헤어지는 길에 손을 잡았어.",
        "이전 요약: 이별의 아픔. 현재 글: 이제 네 연락처를 지웠어.",
        "이전 요약: 새로운 도전. 현재 글: 첫 출근인데 너무 긴장돼.",
        "이전 요약: 고요한 새벽. 현재 글: 가로등 불빛이 외로워 보여.",
        "이전 요약: 가족과의 화해. 현재 글: 엄마가 해준 밥이 따뜻해.",
        "이전 요약: 소소한 행복. 현재 글: 길 가다 주운 만 원으로 로또 샀어.",
        "이전 요약: 졸업식의 눈물. 현재 글: 정든 교정을 떠나려니 울컥해.",
        "이전 요약: 첫 이사의 설렘. 현재 글: 텅 빈 집이 내 꿈들로 채워질 거야.",
        "이전 요약: 비행기 이륙. 현재 글: 창밖으로 구름 위를 나는 기분이야.",
        "이전 요약: 면접 대기실. 현재 글: 심장 소리가 밖으로 들릴 것 같아.",
        "이전 요약: 첫눈 오는 날. 현재 글: 온 세상이 하얗게 덮여서 포근해.",
        "이전 요약: 밤샘 공부. 현재 글: 창가로 비치는 아침 해가 반가워.",
        "이전 요약: 합격 통보. 현재 글: 소리 지르고 싶을 만큼 너무 기뻐!"
    ]

    print("\n" + "="*80)
    print(f"{'No':<3} | {'입력 문장':<35} | {'기존 로직 요약 결과'}")
    print("="*80)

    for i, text in enumerate(test_cases, 1):
        result = tester.test_summary(text)
        display_text = text[:33] + ".." if len(text) > 33 else text
        print(f"{i:<3} | {display_text:<35} | {result}")

if __name__ == "__main__":
    run_100_tests()