# GitHub Actions 상단에 표시될 워크플로우 이름
name: MUTR CI/CD Pipeline

# 워크플로우가 언제 실행될지 정의 (트리거)
on:
  push:
    branches: [ "main" ] # main 브랜치에 코드가 push될 때만 실행

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-northeast3
  REPO_NAME: mutr-repo

jobs:
  # 'build-and-push'라는 이름의 작업 정의
  build-and-push:
    # 작업을 실행할 가상 환경 (GitHub에서 제공하는 최신 우분투)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 1. GCP 인증
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 2. Docker를 Artifact Registry에 로그인 시킴
      - name: 'Docker login'
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # 3. 백엔드 빌드 및 푸시
      - name: Build and Push Backend
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/backend:latest -f ./backend/Dockerfile .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/backend:latest

      # 4. 프론트엔드 빌드 및 푸시
      - name: Build and Push Frontend
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/frontend:latest -f ./frontend/mutr-web/Dockerfile ./frontend/mutr-web
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/frontend:latest
  
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      # 설정 파일들만 서버로 전송 (SCP)
      - name: Copy config files via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USERNAME }}
          key: ${{ secrets.GCP_SSH_KEY }}
          source: "docker-compose.yml,docker-compose.prod.yml,deploy.sh,frontend/mutr-web/nginx.conf.template"
          target: "~/mutr/"

      # SSH를 통해 GCP VM에 접속하여 배포 명령 실행
      - name: SSH Remote Commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          # GitHub Secrets에 저장한 민감 정보들 사용
          host: ${{ secrets.GCP_HOST }} # GCP 외부 IP
          username: ${{ secrets.GCP_USERNAME }} # SSH 접속 계정명
          key: ${{ secrets.GCP_SSH_KEY }} # SSH Private Key
          port: 22 # SSH 표준 포트
          
          # 실제 서버에서 실행할 스크립트
          script: |
            # 1. 프로젝트 폴더로 이동
            cd ~/mutr
            
            # 2. 저장소에서 이미지 가져오기
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml pull
            
            # 3. 블루-그린 무중단 배포 스크립트 실행
            chmod +x deploy.sh
            ./deploy.sh