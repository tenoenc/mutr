# GitHub Actions 상단에 표시될 워크플로우 이름
name: MUTR CI/CD Pipeline

# 워크플로우가 언제 실행될지 정의 (트리거)
on:
  push:
    branches: [ "main" ] # main 브랜치에 코드가 push될 때만 실행
    paths:
      - 'ai-server/**'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-northeast3
  REPO_NAME: mutr-repo

jobs:
  # 'build-and-push'라는 이름의 작업 정의
  build-and-push:
    # 작업을 실행할 가상 환경 (GitHub에서 제공하는 최신 우분투)
    runs-on: ubuntu-latest
    # 이후 단계에서 사용할 출력 변수 정의
    outputs:
      ai: ${{ steps.filter.outputs.ai }}
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. 폴더별 변경 사항 감지
      - uses: dorny/paths-filter@v3
        id: filter
        with:
        filters: |
          ai:
            - 'ai-server/**'
            - 'proto/**'
          backend:
            - 'backend/**'
            - 'proto/**'
          frontend:
            - 'frontend/**'
      
      # 2. GCP 인증
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 3. Docker를 Artifact Registry에 로그인 시킴
      - name: 'Docker login'
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # 4. AI 서버 빌드 및 푸시 (AI 폴더 변경 시에만 실행)
      - name: Build and Push AI Server
        if: steps.filter.outputs.ai == 'true'
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/ai-server:latest -f ./ai-server/Dockerfile .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/ai-server:latest

      # 5. 백엔드 빌드 및 푸시 (백엔드 폴더 변경 시 또는 기존처럼 항상 실행 가능)
      - name: Build and Push Backend
        if: steps.filter.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/backend:latest -f ./backend/Dockerfile .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/backend:latest

      # 6. 프론트엔드 빌드 및 푸시 (프론트엔드 폴더 변경 시에만 실행)
      - name: Build and Push Frontend
        if: steps.filter.outputs.frontend == 'true'
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/frontend:latest -f ./frontend/mutr-web/Dockerfile ./frontend/mutr-web
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/frontend:latest
  
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
    
      # 설정 파일들만 서버로 전송 (SCP)
      - name: Copy config files via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USERNAME }}
          key: ${{ secrets.GCP_SSH_KEY }}
          source: "docker-compose.yml,docker-compose.prod.yml,deploy.sh,frontend/mutr-web/nginx.conf.template"
          target: "~/mutr/"

      # SSH를 통해 GCP VM에 접속하여 배포 명령 실행
      - name: SSH Remote Commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          # GitHub Secrets에 저장한 민감 정보들 사용
          host: ${{ secrets.GCP_HOST }} # GCP 외부 IP
          username: ${{ secrets.GCP_USERNAME }} # SSH 접속 계정명
          key: ${{ secrets.GCP_SSH_KEY }} # SSH Private Key
          port: 22 # SSH 표준 포트
          
          # 실제 서버에서 실행할 스크립트
          script: |
            # 1. 프로젝트 폴더로 이동
            cd ~/mutr

            # 2. Docker가 GCP Artifact Registry에 접근할 수 있게 인증 설정
            gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
            
            # 3. 저장소에서 이미지 가져오기
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml pull
            
            # 4. 블루-그린 무중단 배포 스크립트 실행
            chmod +x deploy.sh
            ./deploy.sh