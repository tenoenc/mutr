# GitHub Actions 상단에 표시될 워크플로우 이름
name: MUTR CI/CD Pipeline

# 워크플로우가 언제 실행될지 정의 (트리거)
on:
  push:
    branches: [ "main" ] # main 브랜치에 코드가 push될 때만 실행

jobs:
  # 'deploy'라는 이름의 작업 정의
  deploy:
    # 작업을 실행할 가상 환경 (GitHub에서 제공하는 최신 우분투)
    runs-on: ubuntu-latest

    steps:
      # 1단계: GitHub 서버(Runner)로 소스 코드를 가져옴
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2단계: SSH를 통해 GCP VM에 접속하여 배포 명령 실행
      - name: SSH Remote Commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          # GitHub Secrets에 저장한 민감 정보들 사용
          host: ${{ secrets.GCP_HOST }} # GCP 외부 IP
          username: ${{ secrets.GCP_USERNAME }} # SSH 접속 계정명
          key: ${{ secrets.GCP_SSH_KEY }} # SSH Private Key
          port: 22 # SSH 표준 포트
          
          # 실제 서버에서 실행할 스크립트
          script: |
            # 1. 프로젝트 폴더로 이동
            cd ~/mutr
            
            # 2. GitHub 저장소의 최신 코드를 서버로 당겨옴
            git pull origin main
            
            # 3. 배포 스크립트에 실행 권한 부여
            chmod +x deploy.sh
            
            # 4. 우리가 만든 블루-그린 무중단 배포 스크립트 실행
            ./deploy.sh